<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Simple Web-Socket Client</title>
<!--
    <script type="text/javascript" src="http://mbostock.github.com/d3/d3.js?1.25.0"></script>
    <script type="text/javascript" src="http://mbostock.github.com/d3/d3.time.js?1.25.0"></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
-->
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

    <link rel="stylesheet" href="style.css">

    <script type="text/javascript">
        /*
        var width = 900;
        var height = 500;
        String.prototype.format = function() {
            var formatted = this;
            for (var i = 0; i < arguments.length; i++) {
                var regexp = new RegExp('\\{'+i+'\\}', 'gi');
                formatted = formatted.replace(regexp, arguments[i]);
            }
            return formatted;
        };


        var dateFormat = d3.time.format("%Y-%m-%d");
        var end = new Date();
        var start = new Date(end.getTime() - 1000 * 60 * 60 * 24 * 60);
        var data = [];

        function min(a, b){ return a < b ? a : b ; }

        function max(a, b){ return a > b ? a : b; }

        function buildChart(data){

            var margin = 50;

            var chart = d3.select("#chart")
                .append("svg:svg")
                .attr("class", "chart")
                .attr("width", width)
                .attr("height", height);
            var y = d3.scale.linear()
                .domain([d3.min(data.map(function(x) {return x["Low"];})), d3.max(data.map(function(x){return x["High"];}))])
                .range([height-margin, margin]);
            var x = d3.scale.linear()
                .domain([d3.min(data.map(function(d){return dateFormat.parse(d.Date).getTime();})),
                    d3.max(data.map(function(d){return dateFormat.parse(d.Date).getTime();}))])
                .range([margin,width-margin]);

            chart.selectAll("line.x")
                .data(x.ticks(10))
                .enter().append("svg:line")
                .attr("class", "x")
                .attr("x1", x)
                .attr("x2", x)
                .attr("y1", margin)
                .attr("y2", height - margin)
                .attr("stroke", "#ccc");

            chart.selectAll("line.y")
                .data(y.ticks(10))
                .enter().append("svg:line")
                .attr("class", "y")
                .attr("x1", margin)
                .attr("x2", width - margin)
                .attr("y1", y)
                .attr("y2", y)
                .attr("stroke", "#ccc");

            chart.selectAll("text.xrule")
                .data(x.ticks(10))
                .enter().append("svg:text")
                .attr("class", "xrule")
                .attr("x", x)
                .attr("y", height - margin)
                .attr("dy", 20)
                .attr("text-anchor", "middle")
                .text(function(d){ var date = new Date(d * 1000);  return (date.getMonth() + 1)+"/"+date.getDate(); });

            chart.selectAll("text.yrule")
                .data(y.ticks(10))
                .enter().append("svg:text")
                .attr("class", "yrule")
                .attr("x", width - margin)
                .attr("y", y)
                .attr("dy", 0)
                .attr("dx", 20)
                .attr("text-anchor", "middle")
                .text(String);

            chart.selectAll("rect")
                .data(data)
                .enter().append("svg:rect")
                .attr("x", function(d) { return x(dateFormat.parse(d.Date).getTime()); })
                .attr("y", function(d) {return y(max(d.Open, d.Close));})
                .attr("height", function(d) { return y(min(d.Open, d.Close))-y(max(d.Open, d.Close));})
                .attr("width", function(d) { return 0.5 * (width - 2*margin)/data.length; })
                .attr("fill",function(d) { return d.Open > d.Close ? "red" : "green" ;});

            chart.selectAll("line.stem")
                .data(data)
                .enter().append("svg:line")
                .attr("class", "stem")
                .attr("x1", function(d) { return x(dateFormat.parse(d.Date).getTime()) + 0.25 * (width - 2 * margin)/ data.length;})
                .attr("x2", function(d) { return x(dateFormat.parse(d.Date).getTime()) + 0.25 * (width - 2 * margin)/ data.length;})
                .attr("y1", function(d) { return y(d.High);})
                .attr("y2", function(d) { return y(d.Low); })
                .attr("stroke", function(d){ return d.Open > d.Close ? "red" : "green"; })

        }


        function appendToData(x){
            if(data.length > 0){
                return;
            }
            data = x.query.results.quote;
            for(var i=0;i<data.length;i++){
                data[i].timestamp = (new Date(data[i].date).getTime() / 1000);
            }
            data = data.sort(function(x, y){ return dateFormat.parse(x.Date).getTime() - dateFormat.parse(y.Date).getTime(); });

            console.log(data);
            buildChart(data);
        }

        function buildQuery(){
            var symbol = window.location.hash;
            if(symbol === ""){
                symbol = "AMZN";
            }
            symbol = symbol.replace("#", "");
            var base = "select * from yahoo.finance.historicaldata where symbol = \"{0}\" and startDate = \"{1}\" and endDate = \"{2}\"";
            var getDateString = d3.time.format("%Y-%m-%d");
            var query = base.format(symbol, getDateString(start), getDateString(end));
            query = encodeURIComponent(query);
            var url = "http://query.yahooapis.com/v1/public/yql?q={0}&format=json&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callback=appendToData".format(query);
            console.log(url);
            return url;
        }
        function fetchData(){
            url = buildQuery();
            scriptElement = document.createElement("SCRIPT");
            scriptElement.type = "text/javascript";
            // i add to the url the call back function
            scriptElement.src = url;
            document.getElementsByTagName("HEAD")[0].appendChild(scriptElement);
        }

        $(document).ready(fetchData);

*/





    </script>
</head>
<body>
<br /><br />
<input type="button" value="HIGH" id="high-button">
<input type="button" value="LOW" id="low-button">
<br />
<div id="bet-result" style="border: 1px solid"> </div>
<br />

<select id="currency-select">

</select>

<br />

<select id="invest-select">

</select>

<!--
<script src="socket.js" type="text/javascript"></script>
-->

<div id="sock-current" style="border: 1px solid"> </div><br />

<div id="chart"></div><br />

<div id="chart2"></div>

<script>

    function min(a, b){ return a < b ? a : b ; }

    function max(a, b){ return a > b ? a : b; }

    function buildChart(data){
        var width = 900;
        var height = 500;

        var margin = 50;

        var dateFormat = d3.time.format("%Y-%m-%d");

        var chart = d3.select("#chart")
            .append("svg:svg")
            .attr("class", "chart")
            .attr("width", width)
            .attr("height", height);
        var y = d3.scale.linear()
            .domain([d3.min(data.map(function(x) {return x["Low"];})), d3.max(data.map(function(x){return x["High"];}))])
            .range([height-margin, margin]);
        var x = d3.scale.linear()
            .domain([d3.min(data.map(function(d){return dateFormat.parse(d.Date).getTime();})),
                d3.max(data.map(function(d){return dateFormat.parse(d.Date).getTime();}))])
            .range([margin,width-margin]);

        chart.selectAll("line.x")
            .data(x.ticks(10))
            .enter().append("svg:line")
            .attr("class", "x")
            .attr("x1", x)
            .attr("x2", x)
            .attr("y1", margin)
            .attr("y2", height - margin)
            .attr("stroke", "#ccc");

        chart.selectAll("line.y")
            .data(y.ticks(10))
            .enter().append("svg:line")
            .attr("class", "y")
            .attr("x1", margin)
            .attr("x2", width - margin)
            .attr("y1", y)
            .attr("y2", y)
            .attr("stroke", "#ccc");

        chart.selectAll("text.xrule")
            .data(x.ticks(10))
            .enter().append("svg:text")
            .attr("class", "xrule")
            .attr("x", x)
            .attr("y", height - margin)
            .attr("dy", 20)
            .attr("text-anchor", "middle")
            .text(function(d){ var date = new Date(d * 1000);  return (date.getMonth() + 1)+"/"+date.getDate(); });

        chart.selectAll("text.yrule")
            .data(y.ticks(10))
            .enter().append("svg:text")
            .attr("class", "yrule")
            .attr("x", width - margin)
            .attr("y", y)
            .attr("dy", 0)
            .attr("dx", 20)
            .attr("text-anchor", "middle")
            .text(String);

        chart.selectAll("rect")
            .data(data)
            .enter().append("svg:rect")
            .attr("x", function(d) { return x(dateFormat.parse(d.Date).getTime()); })
            .attr("y", function(d) {return y(max(d.Open, d.Close));})
            .attr("height", function(d) { return y(min(d.Open, d.Close))-y(max(d.Open, d.Close));})
            .attr("width", function(d) { return 0.5 * (width - 2*margin)/data.length; })
            .attr("fill",function(d) { return d.Open > d.Close ? "red" : "green" ;});

        chart.selectAll("line.stem")
            .data(data)
            .enter().append("svg:line")
            .attr("class", "stem")
            .attr("x1", function(d) { return x(dateFormat.parse(d.Date).getTime()) + 0.25 * (width - 2 * margin)/ data.length;})
            .attr("x2", function(d) { return x(dateFormat.parse(d.Date).getTime()) + 0.25 * (width - 2 * margin)/ data.length;})
            .attr("y1", function(d) { return y(d.High);})
            .attr("y2", function(d) { return y(d.Low); })
            .attr("stroke", function(d){ return d.Open > d.Close ? "red" : "green"; })
    }

    function redraw2()
    {

    }


    var setup = function(targetID){
        //Set size of svg element and chart
        var margin = {top: 0, right: 0, bottom: 0, left: 0},
            width = 600 - margin.left - margin.right,
            height = 400 - margin.top - margin.bottom,
            categoryIndent = 4*15 + 5,
            defaultBarWidth = 2000;

        //Set up scales
        var x = d3.scale.linear()
            .domain([0,defaultBarWidth])
            .range([0,width]);
        var y = d3.scale.ordinal()
            .rangeRoundBands([0, height], 0.1, 0);

        //Create SVG element
        d3.select(targetID).selectAll("svg").remove()
        var svg = d3.select(targetID).append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        //Package and export settings
        var settings = {
            margin:margin, width:width, height:height, categoryIndent:categoryIndent,
            svg:svg, x:x, y:y
        }

        buildChart([{Close: 120.0, High: 125.0, Low: 110.0, Open: 118.0, Date: "2016-12-15"}]);

        return settings;
    }

    var redrawChart = function(targetID, newdata) {

        //Import settings
        var margin=settings.margin, width=settings.width, height=settings.height, categoryIndent=settings.categoryIndent,
            svg=settings.svg, x=settings.x, y=settings.y;

        //Reset domains
        y.domain(newdata.sort(function(a,b){
            return b.value - a.value;
        })
            .map(function(d) { return d.key; }));
        var barmax = d3.max(newdata, function(e) {
            return e.value;
        });
        x.domain([0,barmax]);

        /////////
        //ENTER//
        /////////

        //Bind new data to chart rows

        //Create chart row and move to below the bottom of the chart
        var chartRow = svg.selectAll("g.chartRow")
            .data(newdata, function(d){ return d.key});
        var newRow = chartRow
            .enter()
            .append("g")
            .attr("class", "chartRow")
            .attr("transform", "translate(0," + height + margin.top + margin.bottom + ")");
/*
        //Add rectangles
        newRow.insert("rect")
            .attr("class","bar")
            .attr("x", 0)
            .attr("opacity",0)
            .attr("height", y.rangeBand())
            .attr("width", function(d) { return x(d.value);})

        //Add value labels

        newRow.append("text")
            .attr("class","label")
            .attr("y", y.rangeBand()/2)
            .attr("x",0)
            .attr("opacity",0)
            .attr("dy",".35em")
            .attr("dx","0.5em")
            .text(function(d){return d.value;});

        //Add Headlines
        newRow.append("text")
            .attr("class","category")
            .attr("text-overflow","ellipsis")
            .attr("y", y.rangeBand()/2)
            .attr("x",categoryIndent)
            .attr("opacity",0)
            .attr("dy",".35em")
            .attr("dx","0.5em")
            .text(function(d){return d.key});


        //////////
        //UPDATE//
        //////////

        //Update bar widths
        chartRow.select(".bar").transition()
            .duration(300)
            .attr("width", function(d) { return x(d.value);})
            .attr("opacity",1);

        //Update data labels
        chartRow.select(".label").transition()
            .duration(300)
            .attr("opacity",1)
            .tween("text", function(d) {
                var i = d3.interpolate(+this.textContent.replace(/\,/g,''), +d.value);
                return function(t) {
                    this.textContent = Math.round(i(t));
                };
            });

        //Fade in categories
        chartRow.select(".category").transition()
            .duration(300)
            .attr("opacity",1);


        ////////
        //EXIT//
        ////////

        //Fade out and remove exit elements
        chartRow.exit().transition()
            .style("opacity","0")
            .attr("transform", "translate(0," + (height + margin.top + margin.bottom) + ")")
            .remove();


        ////////////////
        //REORDER ROWS//
        ////////////////

        var delay = function(d, i) { return 200 + i * 30; };

        chartRow.transition()
            .delay(delay)
            .duration(900)
            .attr("transform", function(d){ return "translate(0," + y(d.key) + ")"; });*/
    };



    //Pulls data
    //Since our data is fake, adds some random changes to simulate a data stream.
    //Uses a callback because d3.json loading is asynchronous
    var pullData = function(settings,callback){
        d3.json("fakeData.json", function (err, data){
            if (err) return console.warn(err);

            var newData = data;
            data.forEach(function(d,i){
                var newValue = d.value + Math.floor((Math.random()*10) - 5)
                newData[i].value = newValue <= 0 ? 10 : newValue
            })

            newData = formatData(newData);

            callback(settings,newData);
        })
    }

    //Sort data in descending order and take the top 10 values
    var formatData = function(data){
        return data.sort(function (a, b) {
            return b.value - a.value;
        })
            .slice(0, 10);
    }

    //I like to call it what it does
    var redraw = function(settings){
        pullData(settings,redrawChart);
        console.log("DDd");
    }

    //setup (includes first draw)
    var settings = setup('#chart2');
    redraw(settings)

    //Repeat every 3 seconds
    setInterval(function(){
        redraw(settings)
    }, 3000);
</script>

</body>
</html>